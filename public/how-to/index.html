<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>An Leabharlann Ghealach</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="/leabharlann/css/style.css">
  <link rel="stylesheet" href="/leabharlann/css/spinner.css">
  
  <link rel="stylesheet" href="/leabharlann/css/markdown.css">
  
  <link rel="icon" type="image/x-icon" href="https://uisneac.com/images/Gold-Celtic-Design.png">
</head>
  <body>
    <script src="/leabharlann/scripts/utils.js"></script>
    <script src="/leabharlann/scripts/API.js"></script>
    <script src="/leabharlann/scripts/loading_spinner.js"></script>
      <header>
    <nav class="navbar navbar-expand-lg">
      <div id="logo-and-header">
        <a class="navbar-brand" href="https://uisneac.com" style="margin-right: 0px">
          <img src="https://uisneac.com/images/Gold-Celtic-Design.png" alt="Logo" width="32" height="32" class="d-inline-block align-text-top">
        </a>
        <a class="navbar-brand" href="/leabharlann/index.html">An Leabharlann Ghealach</a>
      </div>
      <form id="search-form" class="d-flex mx-3" style="flex:1;">
        <input id="search-input" class="form-control me-2" type="search" placeholder="Search the databaseâ€¦" aria-label="Search">
        <button class="btn btn-light" type="submit">Search</button>
      </form>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" id="profileMenu" role="button">Account</a>
        </li>
      </ul>
    </nav>
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Log In</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="login-username" required>
              </div>
              <div class="mb-3">
                <label for="login-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="login-password" required>
              </div>
              <div id="errorMessage" class="text-danger mb-3" style="display: none;"></div>
              <button type="submit" class="btn btn-primary">Log In</button>
              <a id="register-button" class="btn btn-link">Register</a>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLabel">Register</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="alert-container"></div>
            <form id="register-form">
              <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="register-username" placeholder="Enter a unique username" required>
                <small class="form-text text-muted">3-20 characters, alphanumeric and underscores only.</small>
                <div class="invalid-feedback"></div>
              </div>
              <div class="mb-3">
                <label for="register-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="register-password" placeholder="Create a password" required>
                <small class="form-text text-muted">At least 8 characters.</small>
                <div class="invalid-feedback"></div>
              </div>
              <div class="mb-3">
                <label for="confirm-password" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirm-password" placeholder="Re-enter your password" required>
                <div class="invalid-feedback"></div>
              </div>
              <button type="submit" id="submit-btn" class="btn btn-primary w-100">Register</button>
            </form>
            <p class="text-center mt-3">Already have an account? <a href="login.html">Log In</a></p>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="searchResultsModal" tabindex="-1" aria-labelledby="searchResultsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="searchResultsModalLabel">Search Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="headerSearchResults" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Helper: parse JWT payload safely
      function parseJwt(token) {
        try {
          const part = token.split('.')[1];
          return JSON.parse(atob(part));
        } catch (e) {
          return {};
        }
      }

      function updateProfileMenu(username) {
        const profileMenu = document.getElementById('profileMenu');
        if (!profileMenu) return;
        const navItem = profileMenu.parentElement;
        profileMenu.textContent = username;
        profileMenu.classList.add('dropdown-toggle');
        profileMenu.setAttribute('data-bs-toggle', 'dropdown');

        // Remove any existing dropdown menu
        const existingDropdown = navItem.querySelector('.dropdown-menu');
        if (existingDropdown) existingDropdown.remove();

        // Build dropdown
        const dropdown = document.createElement('ul');
        dropdown.className = 'dropdown-menu dropdown-menu-end';

        // Profile / account link (optional; you can add more items)
        const profileItem = document.createElement('li');
        const profileLink = document.createElement('a');
        profileLink.className = 'dropdown-item';
        profileLink.href = 'account.html';
        profileLink.textContent = 'Account';
        profileItem.appendChild(profileLink);
        dropdown.appendChild(profileItem);

        // Logout
        const logoutItem = document.createElement('li');
        const logoutLink = document.createElement('a');
        logoutLink.className = 'dropdown-item';
        logoutLink.href = '#';
        logoutLink.textContent = 'Log out';
        logoutLink.addEventListener('click', e => {
          e.preventDefault();
          localStorage.removeItem('token');
          localStorage.removeItem('refreshToken');
          // revert profile menu to default
          profileMenu.textContent = 'Account';
          profileMenu.classList.remove('dropdown-toggle');
          profileMenu.removeAttribute('data-bs-toggle');
          navItem.querySelector('.dropdown-menu')?.remove();
          document.dispatchEvent(new Event('authChange'));
        });
        logoutItem.appendChild(logoutLink);
        dropdown.appendChild(logoutItem);

        navItem.appendChild(dropdown);

        // notify other parts of app
        document.dispatchEvent(new Event('authChange'));
      }

      async function checkAuthStatus() {
        let token = localStorage.getItem('token');
        const refreshToken = localStorage.getItem('refreshToken');

        if (!token) {
          // ensure menu shows default
          const profileMenu = document.getElementById('profileMenu');
          if (profileMenu) {
            profileMenu.textContent = 'Account';
            profileMenu.classList.remove('dropdown-toggle');
            profileMenu.removeAttribute('data-bs-toggle');
            const navItem = profileMenu.parentElement;
            navItem.querySelector('.dropdown-menu')?.remove();
          }
          document.dispatchEvent(new Event('authChange'));
          return;
        }

        try {
          let payload = parseJwt(token);
          // if token expired and we have a refreshToken, try refreshing
          if (payload && payload.exp && Date.now() >= payload.exp * 1000) {
            if (!refreshToken) throw new Error('Token expired');
            const res = await refresh(refreshToken);
            const data = await res.json();
            if (!res.ok) throw new Error(data?.error?.message || 'Token refresh failed');
            // store the new token (and refresh token if returned)
            if (data.token) {
              localStorage.setItem('token', data.token);
              token = data.token;
              payload = parseJwt(token);
            }
            if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);
          }

          // Finally update menu with username (if available)
          const username = payload.username || payload.sub || 'User';
          updateProfileMenu(username);
        } catch (e) {
          console.error('Auth check error:', e);
          localStorage.removeItem('token');
          localStorage.removeItem('refreshToken');
          document.dispatchEvent(new Event('authChange'));
        }
      }

      function displaySearchResults(results, query) {
        const searchResults = document.getElementById('headerSearchResults');
        if (!searchResults) return;
        searchResults.innerHTML = '';

        if (!Array.isArray(results) || results.length === 0) {
          const p = document.createElement('p');
          p.className = 'text-muted';
          p.textContent = `No results found for "${query}"`;
          searchResults.appendChild(p);
        } else {
          results.forEach(node => {
            const label = (node.labels || []).find(l => l !== 'Entity') || 'Node';
            const displayName = (node.properties && (node.properties.display_name || node.properties.name || node.properties.title)) || node.id || 'Unknown';
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action';
            item.href = `/leabharlann/info/index.html?label=${encodeURIComponent(label)}&id=${encodeURIComponent(node.id)}`;
            item.innerHTML = `<strong>${label}</strong>: ${escapeHtml(String(displayName))}`;
            searchResults.appendChild(item);
          });
        }

        const modalEl = document.getElementById('searchResultsModal');
        if (modalEl && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      }

      // Escape HTML text to avoid injecting markup.
      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function (m) {
          return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
        });
      }

      function attachEventListeners() {
        const profileMenu = document.getElementById('profileMenu');
        const loginForm = document.getElementById('loginForm');
        const searchForm = document.getElementById('search-form');
        const registerButton = document.getElementById('register-button');

        if (profileMenu) {
          profileMenu.addEventListener('click', e => {
            // only open modal if not authenticated (menu isn't a dropdown)
            if (!localStorage.getItem('token')) {
              e.preventDefault();
              const loginModalEl = document.getElementById('loginModal');
              if (loginModalEl && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
                const modal = new bootstrap.Modal(loginModalEl);
                modal.show();
              }
            }
          });
        }

        if (loginForm) {
          loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            const usernameEl = document.getElementById('login-username');
            const passwordEl = document.getElementById('login-password');
            const errorMessage = document.getElementById('errorMessage');

            const username = usernameEl?.value?.trim() || '';
            const password = passwordEl?.value || '';

            if (!username || !password) {
              if (errorMessage) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Please fill in all fields';
              }
              return;
            }

            try {
              const response = await login(username, password);
              const data = await response.json();
              if (!response.ok) throw new Error(data?.error?.message || 'Login failed');

              if (data.token) localStorage.setItem('token', data.token);
              if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);

              if (errorMessage) {
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
              }

              const loginModalEl = document.getElementById('loginModal');
              if (loginModalEl && window.bootstrap && bootstrap.Modal.getInstance(loginModalEl)) {
                bootstrap.Modal.getInstance(loginModalEl).hide();
              } else if (loginModalEl && window.bootstrap && typeof bootstrap.Modal === 'function') {
                // fallback: try to hide by creating an instance then hiding
                const m = new bootstrap.Modal(loginModalEl);
                m.hide();
              }

              // Prefer username from returned token payload (if present), else use the submitted username
              const newToken = data.token || localStorage.getItem('token');
              const payload = parseJwt(newToken);
              updateProfileMenu(payload.username || username);
            } catch (err) {
              if (errorMessage) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = err.message || 'Login failed';
              }
            }
          });
        }

        if (searchForm) {
          searchForm.addEventListener('submit', async e => {
            e.preventDefault();
            const q = document.getElementById('search-input')?.value?.trim();
            const errorMessage = document.getElementById('errorMessage');

            if (!q || q.length < 2) {
              if (errorMessage) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Please enter at least 2 characters';
              }
              return;
            }

            try {
              const response = await search(q);
              if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error((data?.error?.message) || 'Search failed');
              }
              const results = await response.json();
              displaySearchResults(results, q);
              if (errorMessage) {
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
              }
            } catch (err) {
              if (errorMessage) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = err.message || 'Search failed';
              }
            }
          });
        }

        if (registerButton) {
          registerButton.addEventListener('click', async e => {
            // Close the login modal
            const loginModalEl = document.getElementById('loginModal');
            if (loginModalEl && window.bootstrap && bootstrap.Modal.getInstance(loginModalEl)) {
              bootstrap.Modal.getInstance(loginModalEl).hide();
            } else if (loginModalEl && window.bootstrap && typeof bootstrap.Modal === 'function') {
              // fallback: try to hide by creating an instance then hiding
              const m = new bootstrap.Modal(loginModalEl);
              m.hide();
            }

            // Open the registration modal
            const registerModalEl = document.getElementById('registerModal');
            if (registerModalEl && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
              const modal = new bootstrap.Modal(registerModalEl);
              modal.show();
            }
          });
        }
      }

      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = ''; // Clear previous alerts

        // Get form data
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        // Client-side validation
        let valid = true;
        const usernameFeedback = document.querySelector('#register-username ~ .invalid-feedback');
        const passwordFeedback = document.querySelector('#register-password ~ .invalid-feedback');
        const confirmFeedback = document.querySelector('#confirm-password ~ .invalid-feedback');

        if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
          document.getElementById('register-username').classList.add('is-invalid');
          if (usernameFeedback) usernameFeedback.textContent = 'Username must be 8-20 characters, alphanumeric and underscores only.';
          valid = false;
        }
        if (password.length < 8) {
          document.getElementById('register-password').classList.add('is-invalid');
          if (passwordFeedback) passwordFeedback.textContent = 'Password must be at least 8 characters long.';
          valid = false;
        }
        if (password !== confirmPassword) {
          document.getElementById('confirm-password').classList.add('is-invalid');
          if (confirmFeedback) confirmFeedback.textContent = 'Passwords do not match.';
          valid = false;
        }

        if (!valid) return;

        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registering...';

        try {
          const response = await register(username, password);
          const data = await response.json();

          if (response.ok) {
            // Show success alert
            alertContainer.innerHTML = '<div class="alert alert-success" role="alert">Account created successfully. Logging in...</div>';

            // Auto-login
            const loginResponse = await login(username, password);
            const loginData = await loginResponse.json();

            if (!loginResponse.ok || !loginData.token) {
              throw new Error(loginData.error?.message || 'Login failed after registration');
            }

            // Store tokens
            localStorage.setItem('token', loginData.token);
            if (loginData.refreshToken) localStorage.setItem('refreshToken', loginData.refreshToken);

            // Close modal and redirect
            const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
            if (registerModal) registerModal.hide();

            setTimeout(() => {
              window.location.href = '.';///leabharlann/index.html'; // Adjust redirect as needed
            }, 1500);
          } else {
            throw new Error(data.error?.message || 'Registration failed');
          }
        } catch (error) {
          alertContainer.innerHTML = `<div class="alert alert-danger" role="alert">${error.message}</div>`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });

      // Clear errors on input
      ['username', 'password', 'confirm-password'].forEach(id => {
        const field = document.getElementById(id);
        if (field) {
          field.addEventListener('input', () => {
            field.classList.remove('is-invalid');
            const feedback = field.nextElementSibling?.nextElementSibling; // Adjust selector if needed
            if (feedback && feedback.classList.contains('invalid-feedback')) {
              feedback.textContent = '';
            }
          });
        }
      });

      // Initialize when DOM ready
      window.addEventListener('DOMContentLoaded', () => {
        attachEventListeners();
        checkAuthStatus();
      });
    </script>
  </header>
    <section>
<!-- Mermaid.js for rendering graph diagrams. -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({ startOnLoad:true });</script>
<style>
  .mermaid {
    display: flex;
    justify-content: center;
  }
</style>
<h1>How to Use An Leabharlann Ghealach</h1>
<p>Welcome to <strong>An Leabharlann Ghealach</strong>, a database for Irish and Celtic source texts. This website will allow users to log and cite texts, keep track of secondary analyses, and discover new texts in the network. An Leabharlann will help keep track of all editions and translations of a text and where they can be found online.</p>
<h2>Directory</h2>
<ul>
<li><a href="#1">1. A Graph Database</a></li>
<li><a href="#2">2. How is the Database Structured?</a></li>
<li><a href="#labels">Labels</a></li>
</ul>
<p><a id="1"></a></p>
<h3>1. A Graph Database</h3>
<p><a href="https://neo4j.com" target="_blank">Neo4j</a> is a graph database language designed to store data as <strong>nodes</strong>, and connections between data as <strong>relationships</strong>. Unlike traditional databases that use tables, Neo4j organizes data into a graph structure, making it ideal for representing complex relationships, such as those between authors, texts, editions, publishers, websites, and text versions in this application.</p>
<ul>
<li><strong>Nodes</strong>: Represent entities like Authors, Texts, or Publishers. Any data which might have multiple data points under it should be a node with properties. Each node has labels (e.g., 'Author', 'Text') and properties (e.g., 'name: &quot;Jane Doe&quot;').</li>
<li><strong>Relationships</strong>: Connect nodes through relationships like A 'WROTE' B or C 'PUBLISHED' D, allowing us to model how entities are related.</li>
</ul>
<p>A node has properties, and a relationship connects nodes. For example, if we had a node for Homer, it would look like this:</p>
<div class="mermaid">
graph LR
  H(("Author<br>name: Homer<br>born: 8th c. BC")):::entity
  classDef entity fill:#f9f9f9,stroke:#333,stroke-width:1px;
</div>
<p>And if we had a node for the Iliad, it could look like this:</p>
<div class="mermaid">
graph LR
  I(("Text<br>title: The Iliad<br>language: Ancient Greek")):::entity
  classDef entity fill:#f9f9f9,stroke:#333,stroke-width:1px;
</div> 
<p>Then we could relate them by saying that Homer WROTE The Iliad:</p>
<div class="mermaid">
graph LR;
  H(("Author<br>name: Homer<br>born: 8th c. BC")):::entity
  I(("Text<br>title: The Iliad<br>language: Ancient Greek")):::entity
  H -->|WROTE| I
  classDef entity fill:#f9f9f9,stroke:#333,stroke-width:1px;
</div>
<p>You can see that each node is given a <strong>label</strong>, here &quot;Author&quot; and &quot;Text&quot;. The name of the author and title of the text are properties stored <em>within</em> a node. All nodes have labels telling you what they <em>are</em>, while the properties of a node tell you <em>about</em> the data stored within. So Homer IS AN Author, and the Iliad IS A Text. This feature will become useful later when we discuss searching through the database. Note that a node can have an arbitrary number of labels, e.g. James Clarence Mangan IS AN Author and IS A Translator.</p>
<p><a id="2"></a></p>
<h3>2. How is the Database Structured?</h3>
<p>Due to the complexity of relationships in the humanities, no rigid structure could ever capture the unruly relationships of a humanities database without itself becoming unruly. But Neo4j allows users to set relationships that could be unique, as well as relationships that are extremely common. To capture all of these, users can create many different labels to suit their needs.</p>
<p>A node consists of a <strong>label</strong> and a list of <strong>properties</strong> and their values. There is no limit on what a label or property could be, although the value of a property must be a string or simple array, not a JSON object.</p>
<p>For example, the <em>Audacht Morainn</em> is a medieval Irish document. It is a <strong>Text</strong>. But Fergus Kelly's 1970 translation of the <em>Audacht Morainn</em> is an <strong>Edition</strong> and a <strong>Translation</strong> of that Text, not a Text itself. The two are connected with an EDITION_OF relationship. And Fergus Kelly TRANSLATED the <em>Audacht Morainn</em>. So we can create nodes with those properties, and connect them:</p>
<div class="mermaid">
graph LR
  E(("Edition<br>title: Audacht Morainn<br>publication_date: 1970")):::edition
  T(("Text<br>title: Audacht Morainn")):::text
  F(("Author Translator<br>name: Fergus Kelly")):::person
  E -->|EDITION_OF| T
  F -->|WROTE| E
  F -->|TRANSLATED| T
  classDef edition fill:#f9f9f9,stroke:#333,stroke-width:1px;
  classDef text    fill:#f9f9f9,stroke:#333,stroke-width:1px;
  classDef person  fill:#f9f9f9,stroke:#333,stroke-width:1px;
</div>
<p>See <a href="#labels">Labels</a> below for a full list of all labels used and how to use them.</p>
<h3>3. Logging In</h3>
<h3>4. The Homepage</h3>
<p>Columns, searching, and logging in.</p>
<h3>5. Creating a Node</h3>
<p>Creating a node, adding labels, node properties, and relationships.</p>
<h3>6. Relationships</h3>
<p>Nodes connect to each other through relationships.</p>
<p><a id="labels"></a></p>
<h2>Labels</h2>
<p>A list of all currently used labels and when / how to use each:</p>
<p><a id="author"></a></p>
<h3>Author</h3>
<blockquote>
<p>Used for all people who write, edit, or translate a <a href="#Text">Text</a>.</p>
</blockquote>
<p><a id="text"></a></p>
<h3>Text</h3>
<blockquote>
<p>A Text is the pure form of a document or writing, the Platonic ideal of a text, not associated with any edition or translation.</p>
<p>For example, the Iliad is a Text, written by Homer. Robert Fagles' 1990 book titled &quot;The Iliad&quot; by Homer, published by Penguin Classics, in which he translates the epic into English, is also the Iliad by Homer, but not the pure Text itself. Rather, it is an Edition and Translation of the Text.</p>
<p>The Text is an umbrella category under which are organized all other nodes related to that Text.</p>
</blockquote>
<p><a id="edition"></a></p>
<h3>Edition</h3>
<blockquote>
<p>A printed or published instantiation of a <a href="#Text">Text</a>, which appears on its own as a standalone book or article, or is published in a journal, or is contained in an anthology.</p>
<p>A book like <em>The Lord of the Rings: Return of the King</em> is a Text, and all the many printings and reprintings of that book are its <strong>Editions</strong>; but at the same time, a Text like the <em>Bretha DÃ©in ChÃ©cht</em> was published in <em>Ã‰riu</em> Vol. XX, along with a new translation, and both the original text and translation count as <strong>Editions</strong> of the original Text.</p>
</blockquote>
<p><a id="publisher"></a></p>
<h3>Publisher</h3>
<h3>Translation</h3>
<h2>Relationships</h2>
<h2>WROTE</h2>
<blockquote>
<p>Points from an Author to a Text or Edition that he wrote. This should also be used for the editor of a work, even if that person didn't specifically author the text itself.</p>
</blockquote>
</section>
  </body>
</html>
